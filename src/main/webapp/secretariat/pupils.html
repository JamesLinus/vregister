<!DOCTYPE html>
<html>
    <body class="lift:content_id=main">
        <div id="main" class="lift:surround?with=secret;at=content">
            <head_merge><link rel="stylesheet" type="text/css" href="/style/register.css" />
                <script type="text/javascript" charset="utf-8" src="/style/common_users.js"></script>
                <script type="text/javascript" charset="utf-8">
                    $dTable = $();
                    $(document).ready(function() {
                
                        $dTable = $('#fullList').dataTable();
                        bindEditCell();
                        $('#formAdd').dialog({
                            autoOpen: false,
                            height: 300,
                            width: 400,
                            modal: true,
                            close: function(){
                                bindEditCell();
                            }
                        });
                        //zmiana ikonki w skreślonych użytkownikach
                        $('#fullList').children('tbody').children('tr').each(function() {
                            var $tr = $(this);
                            if($tr.hasClass('scratched')) {
                                $tr.children('td:last').children('input').attr('src','/style/images/addico.png');
                            }           
                        });
                        
                        $( "#birthDateAdd" ).datepicker({
                            changeMonth: true,
                            changeYear: true,
                            yearRange: '1980:2010' ,
                            defaultDate: '-14y',
                            dateFormat: 'yy-mm-dd',
                            prevText : "poprzedni",
                            nextText : "następny",
                            dayNamesMin: ['Ni','Po','Wt','Śr','Cz','Pi','So'],
                            monthNamesShort: ['Sty','Lut','Mar','Kwi','Maj','Cze','Lip','Sie', 'Wrz','Paź','Lis','Gru'] 
                        });
                        
                         $( "#calendarEdit" ).datepicker({
                            changeMonth: true,
                            changeYear: true,
                            yearRange: '1980:2010' ,
                            defaultDate: '-14y',
                            dateFormat: 'yy-mm-dd',
                            prevText : "poprzedni",
                            nextText : "następny",
                            dayNamesMin: ['Po','Wt','Śr','Cz','Pi','So','Ni'],
                            monthNamesShort: ['Sty','Lut','Mar','Kwi','Maj','Cze','Lip','Sie', 'Wrz','Paź','Lis','Gru'] 
                        });
                
                    } );
    
                    function bindEditCell(){
                        $('#fullList').children('tbody').children('tr').each(function(){
                            $(this).children('td').each(function(index){
                                if( index > 1 && index < 6) {
                                    var $td = $(this);
                                    $td.dblclick(function(){editCell(this);});
                                }        
                            });
            
                        });
                    }
                    
                     //usunięcie dodanego w danej sesji
                    function deleteUser(elem) {
                        var $tr = $(elem).parent('td').parent('tr');
                        var id = parseInt($tr.children('td:first').text());
                        for (i in users){
                            if (users[i].id == id){
                                users.splice(i,1);
                            }
                        }
                        $dTable.fnDeleteRow( $tr.get()[0]);
                        //$tr.remove();
                        incraseToSaveInfo();
                    }
            
                    function showAddUser(){
                        $('#formAdd').dialog('open');
                    }
               
                    function editCell(elem) {
                        $elem = $(elem); //td
                        $elem.unbind();
                        //if ($elem.hasClass('iduser') || $elem.hasClass('scratch')) return;
                        closeEdit();
                        oldCellValue = $elem.text();
               
                        $editedTd = $elem;
               
                        $elem.text('');
                        $elem.attr('id','EDITED');
                        var column = columnNumber();
                        if (column == 4) {
                            $elem.append('<span id="editedInfo" id="editInfo" class="errorInfo"></span>');
                            var $inputEd = $('#calendarEdit').show();
                            $inputEd.val(oldCellValue);
                            $elem.append($inputEd);
                            $elem.append('<input  title="OK" type="image" src="/style/images/okico.png" onclick="saveAndCloseEditDate()" />');
                   
                        }
                        else if (column == 5){
                            $elem.append('<span id="editedInfo" id="editInfo" class="errorInfo"></span>');
                            $elem.append('<input id="editedInput" type="text" value="' + oldCellValue + '" size="13" maxlength="13" />');
                            $elem.append('<input  title="OK" type="image" src="/style/images/okico.png" onclick="saveAndCloseEdit()" />')
                        }
                        else {
                            $elem.append('<span id="editedInfo" id="editInfo" class="errorInfo"></span>');
                            $elem.append('<input id="editedInput" type="text" value="' + oldCellValue + '" size="12" maxlength="32" />');
                            $elem.append('<input  title="OK" type="image" src="/style/images/okico.png" onclick="saveAndCloseEdit()" />')
                        }
                    }
           
                    
           
                    function closeEdit(){
                        //alert('children: '+ $editedTd.attr('class')); //testowe
                        var col = columnNumber();
                        if (col == 4) {
                            var $calendarEdit = $('#calendarEdit');
                             $calendarEdit.hide();
                            $('#hiddenBox').append($calendarEdit);
                        }
                        $editedTd.removeAttr('id');
                        $editedTd.text(oldCellValue);
                        $editedTd.dblclick(function(){editCell(this);});
                        $editedTd = $();
                    }

           
                    function saveAndCloseEdit(){
                        var newValue = jQuery.trim($('#editedInput').val());
                        if (oldCellValue != newValue) {
                            //nieprawidłowy wpis wychodzę!!!
                            if (!validateNewValue(newValue)) return;
                            var $editedTr = $editedTd.parent('tr');
                   
                            //zamykam edycję i podmieniam dane
                            oldCellValue = newValue;
                            $editedTd.text(oldCellValue);
                            addDataToUsersArray($editedTr);
                        }
                        closeEdit();
                    }
                    
                    function saveAndCloseEditDate() {
                        $calendarEdit = $('#calendarEdit');
                        var newValue = jQuery.trim($calendarEdit.val());
                        if (oldCellValue != newValue) {
                            var $editedTr = $editedTd.parent('tr');
                            //zamykam edycję i podmieniam dane
                            oldCellValue = newValue;
                            closeEdit();
                            addDataToUsersArray($editedTr);
                        }
                        else closeEdit();
                    }
    
                    function  validateNewValue(newValue){
                        var column = columnNumber();
                        var isValid = true;
                        switch (column){
                            case 2:
                            case 3:
                                isValid = validateName(newValue);
                                $('#editedInfo').text(info);
                                break;
                            case 5:
                                isValid = validatePesel(newValue);
                                $('#editedInfo').text(info);
                                break;
                            default:
                                break;
                        }
                        return isValid;
                    }
               
                    function addDataToUsersArray($editedTr){
                        var foundInArray = false;
                        var user = new User();
                        if ($editedTr.hasClass('scratched')) user.toDel = true;
                        $editedTr.children('td').each(function(index){
                            switch (index){
                                case 0:
                                    user.id = parseInt(this.innerHTML);
                                    break;
                                case 1:
                                    user.reg = parseInt(this.innerHtml);
                                    break;
                                case 2:
                                    user.lastName = this.innerHTML;
                                    break;
                                case 3:
                                    user.firstName = this.innerHTML;
                                    break;
                                case 4:
                                    user.bithDate = this.innerHTML;
                                    break;
                                case 5:
                                    user.pesel = this.innerHTML;
                                    break;
                                default:
                                    break;
                            }
                        });
                        for(i in users){
                            if (users[i].id == user.id) {
                                foundInArray = true;
                                users[i].fistName = user.firstName;
                                users[i].lastName = user.lastName;
                                users[i].reg = user.reg;
                                users[i].pesel = user.pesel;
                                users[i].birthDate = user.birthDate;
                                users[i].toDel = user.toDel;
                                break;
                            }
                        }
                        if (!foundInArray){
                            users.push(user);  
                            incraseToSaveInfo();
                        }
                    }
           
          
           
         
           
                    function addUser(elem) {
                        var isError = false;
                        clearFormsAddInfo();
                        var firstName = jQuery.trim($('#firstNameAdd').val());
                        if (!validateName(firstName)) {
                            $('#firstNameAddInfo').text(info);
                            isError = true;
                        }
                        var lastName = jQuery.trim($('#lastNameAdd').val());
                        if (!validateName(lastName)) {
                            $('#lastNameAddInfo').text(info);
                            isError = true;
                        }
                        var birthDate = jQuery.trim($('#birthDateAdd').val());
                        var pesel = jQuery.trim($('#peselAdd').val());
                        if (!validatePesel(pesel)) {
                            $('#peselAddInfo').text(info);
                            isError = true;
                        }
                        if (!isError) {
                            var id = negativeId;
                            var reg = negativeId--;
                            $dTable.fnAddData([id, reg, lastName,firstName, birthDate, pesel,
                                '<input type="image" src="/style/images/delico.png" onclick="deleteUser(this)" />']);
                            var user = new User();
                            user.id = id;
                            user.reg = reg;
                            user.lastName = lastName;
                            user.firstName = firstName;
                            user.pesel = pesel;
                            user.birthDate = birthDate;
                            users.push(user);
                            incraseToSaveInfo();
                            clearFormsAdd();
                            $('#addInfo').text('Dodano: ' + firstName + ' ' + lastName);
                        } else  $('#addInfo').text('Nie zapisano');
                        return !isError;
               
                    }
                 
                    function User() {
                        this.id = 0;
                        this.reg = 0;
                        this.firstName = "";
                        this.lastName = "";
                        this.birthDate = "";
                        this.pesel = "";
                        this.toDel = false;
                    }
                       
   
   
                    //globals
                    var users = new Array();
                    var negativeId = -1;
                    var oldCellValue = "";
                    var $editedTd = $();
                       
                       
                    function createData(){
                        var xml = '<root>';
                        for (i in users){
                            xml += '<user id="';
                            xml += users[i].id.toString();
                            xml += '" scratch="';
                            if (users[i].toDel) xml += 't';
                            else xml += 'n';
                            xml += '" reg="';
                            xml += users[i].reg.toString();
                            xml += '" ><firstName>';
                            xml += users[i].firstName;
                            xml += '</firstName><lastName>';
                            xml += users[i].lastName;
                            xml += '</lastName><birthDate>';
                            xml += users[i].birthDate;
                            xml += '</birthDate><pesel>';
                            xml += users[i].pesel;
                            xml += '</pesel></user>';
                        }
                        xml += '</root>';
                        $('#dataEdit').val(xml);
                        alert($('#dataEdit').val());
                        $('#submit').click();
                        return false;
                    }                    
                       
                </script>
                <style >
                    #errorInfo { font-style: italic; font-weight: bold; color: red;}
                    .scratched td {text-decoration: line-through;}
                </style>
            </head_merge>

            <div id="centrum">
                <div id="infoHead">
                    <div class="lift:AddTeacherSn.logedInUser userName" style="width:200px;display: inline;">Jesteś zalogowany jako: <p id="username"></p></div>
                    <form class="lift:AddTeacherSn.formItem" method="POST">
                        <fieldset  style="width:200px;display: inline;">
                            <legend>Status zmian</legend>
                            <label for="editRows">Do zmiany:</label><input id="editRows" type="text" readonly="true" value="0" size="2" />
                            <input id="dataEdit" />
                            <input style="display:none;" id="saveButton" onclick="return createData()" src="/style/images/saveico.png" type="image" />
                            <input id="submit"/>

                        </fieldset></form>
                </div> <!--inofhead-->
                <br  />



                <h3>Przegląd i edycja nauczycieli </h3><hr />
                <input type="image" src="/style/images/addico.png" onclick="showAddUser()" />
                <table id="fullList" class="display" border="0" cellpadding="2" cellspacing="2" >
                    <thead>
                        <tr><th>ID</th><th>Nr księgi</th><th>Nazwisko</th><th>Imię</th>
                            <th>Data urodzenia</th><th>PESEL</th><th>+/-</th>
                        </tr>
                    </thead>

                    <tbody class="lift:AddTeacherSn.teacherList">
                        <tr >
                            <td class="iduser"></td>
                            <td class="reg"></td>
                            <td  class="lastname"></td>
                            <td  class="firstname"></td>
                            <td class="birthdate"></td>
                            <td class="pesel"></td>
                            <td class="scratch">
                                <input  type="image" src="/style/images/delico.png"  onclick="toggleScratch(this)" />
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div id="formAdd" style="display: none;" title="Dodawanie nowych uczniów">
                    <table>
                        <tr>
                            <td><label for="lastNameAdd">Nazwisko:</label></td>
                            <td><input id="lastNameAdd" type="text" size="18" maxlength="32"/></td>
                            <td><span id="lastNameAddInfo" class="errorInfo"></span></td>
                        </tr>
                        <tr>
                            <td><label for="firstNameAdd">Imię:</label></td>
                            <td><input id="firstNameAdd" type="text" size="18" maxlength="32"/></td>
                            <td><span id="firstNameAddInfo" class="errorInfo"></span></td>
                        </tr>
                        <tr>
                            <td><label for="bithDateAdd">Data urodzenia:</label></td>
                            <td><input id="birthDateAdd" type="text"  /></td>
                            <td><span id="birthDateAddInfo" class="errorInfo"></span></td>
                        </tr>
                        <tr>
                            <td><label for="peselAdd">PESEL:</label></td>
                            <td><input id="peselAdd" type="text" size="10" maxlength="13" /></td>
                            <td><span id="peselAddInfo" class="errorInfo"></span></td>
                        </tr>
                        <tr>
                            <td colspan="2"></td><td><input  title="Zapisz" type="image" src="/style/images/addico.png" name="add" onclick="addUser(this)" /> 
                                <input type="image" title="Czyść formatkę" name="clear" onclick="clearFormsAdd()" src="/style/images/resetico.png" value="" /></td>
                        </tr>
                    </table>
                    <p id="addInfo"></p>
                </div>
                <br  />
                <div id="hiddenBox" ><input type="text" id="calendarEdit" style="display: none;" value="" /></div>
            </div>
    </body>
</html>

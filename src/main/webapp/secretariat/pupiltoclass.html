<!DOCTYPE html>
<html>
    <body class="lift:content_id=main">
        <div id="main" class="lift:surround?with=secret;at=content">
            <head_merge><link rel="stylesheet" type="text/css" href="/style/register.css" />
                <script type="text/javascript" charset="utf-8" src="/style/common_users.js"></script>
                <script type="text/javascript" charset="utf-8">
                    //globals
                    var theClass = "";
                    var $dTableFull = $();
                    var $dTableFree = $();
                    var users = new Array();
                    
                    $(document).ready(function() {
                        $dTableFull = $('#fullListClass').dataTable({
                            
                            "bPaginate": false
                            
                        });
                        
                        
                        $dTableFree = $('#fullListFree').dataTable({
                            
                        });
                        
                        $('#fullListClass_filter').hide();
                        bindAssign();
                        bindUnassign();
                        changeClass();
                    });
                    
                       
                    function bindAssign(){
                        $('#fullListFree tbody tr').each(function(){
                            $(this).dblclick(function(){assignToClass(this);});
                        }); 
                    }
                    
                    function bindUnassign(){
                        $('#fullListClass tbody tr').each(function(){
                            $(this).dblclick(function(){unassignFromClass(this);});
                        }); 
                    }
                    
                    
                    function assignToClass(elem){
                        //dodać dziłania sprawdzające czy uczeń jest na liście do wycofania z klasy
                        var $tr = $(elem);
                        var text  = $tr.children('td').text();
                        var id = parseInt(text.match(/\d+/));
                        var tClass = $('#selectedClass').val();
                        var found = false;
                        for(i in users){
                            if( id == users[i].id) {
                                found = true;
                                if(users[i].classFrom == tClass){ //początkowo był w tej klasie więc nie ma zmiany
                                    users.splice(i,1);
                                    incraseToSaveInfo();
                                }
                                else users[i].classTo = tClass;
                            }
                        }
                        if(!found){
                            var user = new User();
                            user.id = id;
                            user.str = text;
                            user.classTo = tClass;
                            users.push(user);
                            incraseToSaveInfo();
                        }
                        
                        $dTableFull.fnAddData([text,tClass ]);
                        $('#fullListClass tbody tr').each(function(){
                            $(this).unbind().dblclick(function(){unassignFromClass(this);});
                        });
                        $dTableFree.fnDeleteRow( $tr.get()[0]);
                        
                    }
                    
                    function unassignFromClass(elem){
                        var $tr = $(elem);
                        var text  = $tr.children('td:first').text();
                        var toDelete  = confirm("Usunąć" + text + " z klasy?");
                        if (toDelete){
                            var tClass = $tr.children('td:last').text();
                            var id = parseInt(text.match(/\d+/));
                            var found = false;
                            for(i in users){
                                if(users[i].id == id){
                                    found = true;
                                    if(users[i].classFrom == ""){
                                        users.splice(i,1);
                                        incraseToSaveInfo();
                                    }
                                }
                            }
                            if(!found){
                                var user = new User();
                                user.id = id;
                                user.str = text;
                                user.classFrom = tClass;
                                users.push(user);
                                incraseToSaveInfo();
                            }
                            $dTableFree.fnAddData([text ]);
                            $('#fullListFree tbody tr').each(function(){
                            $(this).unbind().dblclick(function(){assignToClass(this);});
                             });
                            $dTableFull.fnDeleteRow( $tr.get()[0]);
                        
                        }
                    }
                    
                    function User() {
                        this.id;
                        this.str = "";
                        this.classFrom= "";
                        this.classTo = "";
                    }
                    
                    //wyświetlanie uczniów z klasy wybranej w select
                    function changeClass(){
                        var tClass = $('#selectedClass').val();
                        $dTableFull.fnFilter(tClass,1);
                    }   
                       
                       
                    function createData(){
                        var xml = '<root>';
                        for (i in users){
                            xml += '<user id="';
                            xml += users[i].id.toString();
                            xml += '" ><toClass>';
                            if (users[i].classTo != "") {
                                var temp = users[i].classTo.match(/\[\d+\]/).toString();
                                xml += temp.substring(1,temp.length - 1);
                            }
                            xml += '</toClass><fromClass>';
                            if (users[i].classFrom != ""){
                                var temp = users[i].classFrom.match(/\[\d+\]/).toString();
                                xml += temp.substring(1,temp.length - 1);
                            }
                            xml += '</fromClass></user>';
                        }
                        xml += '</root>';
                        $('#dataEdit').val(xml);
                        alert($('#dataEdit').val());
                        $('#submit').click();
                        return false;
                    }                    
                       
                </script>
            </head_merge>

            <div id="centrum">
                <div id="infoHead">
                    <form class="" method="POST">
                        <fieldset  style="width:200px;display: inline;">
                            <legend>Status zmian</legend>
                            <label for="editRows">Do zmiany:</label><input id="editRows" type="text" readonly="true" value="0" size="2" />
                            <input id="dataEdit" />
                            <input style="display:none;" id="saveButton" onclick="return createData()" src="/style/images/saveico.png" type="image" />
                            <input id="submit"/>

                        </fieldset></form>
                </div> <!--inofhead-->
                <br  />



                <h3>Przydział uczniów do klas </h3><hr />
           
                
                
                <table class="" ><tr><td width="450"><br/>
                            <div class=""><select><option>wybór</option></select></div>
                    <table  id="fullListClass" class="display" border="0" cellpadding="2" cellspacing="2" >
                       
                        <thead> <tr><th id="inClass">Uczeń</th><th>Klasa</th></tr></thead>
                        <tbody id="pupilInClass"><tr><td></td></tr></tbody>
                    </table>   
                            
                     </td><td></td><td width="450">
                         
                        <table id="fullListFree" class="display" border="0" cellpadding="2" cellspacing="2" >
                            <thead> <tr><th id="offClass">Uczeń nieprzydzielony:</th></tr></thead>
                            <tbody ><tr  id="pupilOffClass"><td></td></tr></tbody>
                        </table>   
                         
                         
                     </td></tr>
                </table>
                

               
                    <p id="addInfo"></p>
                </div>
                <br  />
            </div>
    </body>
</html>

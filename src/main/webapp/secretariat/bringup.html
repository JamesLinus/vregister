<!DOCTYPE html>
<html>
    <body class="lift:content_id=main">
        <div id="main" class="lift:surround?with=secret;at=content">
            <head_merge><link rel="stylesheet" type="text/css" href="/style/register.css" />
                <script type="text/javascript" charset="utf-8" src="/style/common_users.js"></script>
                <script type="text/javascript" charset="utf-8">
                    //globals
                    var isEdited = false;
                    var $editedElem = $();
                    var teacher = "";
                    function theClass(){
                        var idClass = 0;
                        var idTeacher = 0;
                    }
                    var users = new Array();
                    
                    $(document).ready(function() {
                            $("#fullList tr td.teacher").each(function(){
                                $(this).dblclick(function(){ editTeacher(this);});
                            });
                      
                        });
                        
                        function editTeacher(elem){
                            if(isEdited){
                               closeEdit();
                            } 
                            isEdited = true;
                                $editedElem = $(elem);
                                $editedElem.unbind();
                                teacher = $editedElem.text();
                                var $select = $('#hiddenSelect').clone();
                                $select.attr('id','editedSelect');
                                $select.val(teacher);
                                $editedElem.text('');
                                $editedElem.append($select);
                                $editedElem.append('<input  title="OK" type="image" src="/style/images/okico.png" onclick="saveAndCloseEdit()" />');
                                $select.show(100);
                           
                            
                        }
                        
                        function closeEdit(){
                            $editedElem.children().remove();
                            $editedElem.text(teacher);
                            $editedElem.dblclick(function(){editTeacher(this);});
                            $editedElem = $();
                        }
                        
                        function saveAndCloseEdit(){
                            var newTeacher = $editedElem.children('select').val();
                            alert(newTeacher);
                            if(newTeacher != teacher && newTeacher != 'brak') {
                                $editedElem.children().remove();
                                teacher = newTeacher;
                                $editedElem.text(teacher);
                                var classStr = 0;
                                var teacherStr = 0;
                                $editedElem.parent().children().each(function(index){
                                    if(index == 0) classStr = $(this).text();
                                    if(index == 1) teacherStr = $(this).text();
                                })
                                var idClass = idFromString(classStr);
                                var idTeacher = idFromString(teacherStr);
                                var found = false;
                                for(i in users){
                                    if (users[i].idClass == idClass){
                                        found = true;
                                        users[i].idTeacher = idTeacher;
                                        break;
                                    }         
                                }
                                if (!found){
                                    var newClass = new theClass();
                                    newClass.idClass = idClass;
                                    newClass.idTeacher = idTeacher;
                                    users.push(newClass);
                                }
                                incraseToSaveInfo();
                                $editedElem.dblclick(function(){editTeacher(this);});
                                $editedElem = $();
                            } 
                            else {
                                closeEdit();
                            }  
                            isEdited = false;
                        }
                        
                        function idFromString(str){
                            var newStr = str.match(/\[\d+\]/)[0]
                            newStr = newStr.substring(1,newStr.length -1);
                            var intId = parseInt(newStr);
                            return isNaN(intId) ? -1 : intId;
                        }
                        
                        function createData(){
                            if (users.length == 0) return false;
                            var xml = '<root>';
                            for(i in users){
                                xml += '<theclass idClass="';
                                xml += users[i].idClass.toString();
                                xml += '" idTeacher="';
                                xml += users[i].idTeacher.toString();
                                xml += '"></theclass>';
                            }
                            xml += '</root>';
                            alert(xml);
                            $('#dataEdit').val(xml);
                            $('#submit').click();
                            return false;
                        }
                       
                </script>
            </head_merge>

            <div id="centrum">
                <div id="infoHead">
                    <div class="lift:AssignationSn.logedInUser userName" style="width:200px;display: inline;">Jesteś zalogowany jako: <p id="username"></p></div>
                    <form class="lift:AssignationSn.formItemBringup" method="POST">
                        <fieldset  style="width:200px;display: inline;">
                            <legend>Status zmian</legend>
                            <label for="editRows">Do zmiany:</label><input id="editRows" type="text" readonly="true" value="0" size="2" />
                            <input id="dataEdit" />
                            <input style="display:none;" id="saveButton" onclick="return createData()" src="/style/images/saveico.png" type="image" />
                            <input id="submit"/>

                        </fieldset></form>
                </div> <!--inofhead-->
                <br  />



                <h3>Przydział wychowawstwa: </h3><hr />
                
                <table id="fullList" class="display" border="0" cellpadding="2" cellspacing="2" >
                    <thead>
                        <tr><th>Klasa</th><th>Nauczyciel</th></tr>
                    </thead>

                    <tbody class="lift:AssignationSn.bringupList">
                        <tr ><td class="classes"></td><td  class="teacher"></td></tr>
                    </tbody>
                </table>

                <br  />
                <div id="hiddenBox" class="lift:AssignationSn.teacherSelect" ><select type="text" id="teacherSelect" style="display: none;">
                        <option>wybierz</option><option>pierwszy</option></select></div>
            </div>
    </body>
</html>
